<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <script type="text/javascript"  th:src="@{/jquery-3.4.0/jquery-3.4.0.min.js}"></script>
    <link th:href="@{/bootstrap/bootstrap-3.3.7/css/bootstrap.min.css}" rel="stylesheet" type="text/css" >

    <script type="text/javascript"  th:src="@{/bootstrap/bootstrap-3.3.7/js/bootstrap.min.js}"></script>
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet">

    <style th:inline="text">
        table{border-spacing: 10px 30px;}
        tr {
            display: block;
            /*将tr设置为块体元素*/
            margin: 3px 0;
            /*设置tr间距为2px*/
        }

        td {
            text-align: right;
        }

        .layui-tab-content {
            height: 200vh;
        }

        input[type=‘text‘]{background:none;border:none;}
        .inp{
            border:none;
            outline:none;
            display: block;
            width: 100%;
            padding-left: 10px;
            height: 38px;
            line-height: 1.3;
            line-height: 38px;
            background-color: #fff;
            border-radius: 2px;
        }

        .round_white_img {
            left: 0;
            top: 0;
            width: 140px;
            height: 140px;
            border-radius:48%;
        }

        .btn button {
            display: block;
            height: 100%;
            background-color: transparent;
            border: 0;
            outline: 0;
            overflow: visible;
            padding: 0 22px;
        }

    </style>
</head>
<body>

<div>
    <div>
        <label style="font-size: 26px;">个人设置</label>
    </div>
    <div style="margin-left: 2%; margin-top: 1%">
        <div style=" margin: 0 auto; text-align:center">
            <div id="initAccountPic"></div>
        </div>
        <div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">名称</label>
                <div class="layui-input-block">
                        <input type="text" id="username" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.username}" class="inp">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">账号</label>
                <div class="layui-input-block">
                    <input type="text" id="account" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.account}" class="inp">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">权限</label>
                <div class="layui-input-block">
                    <input type="text" id="level" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.level}" class="inp">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">所在地</label>
                <div class="layui-input-block">
                    <input type="text" id="address" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.address}" class="inp">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">账户创建者</label>
                <div class="layui-input-block">
                    <input type="text" id="author" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.author}" class="inp">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width: 100px">密码</label>
                <div class="layui-input-block">
                    <input type="text" id="password" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.password}" class="inp">
                </div>
            </div>
            <div class="layui-form-item" style="display: none">
                <label class="layui-form-label" style="width: 100px">头像</label>
                <div class="layui-input-block">
                    <input type="text" id="picture" readonly="readonly" style="width:500px;" lay-verify="title" autocomplete="off" th:value="${session.accountInfo.picture}" class="inp">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addModel" style="display: none;">
    <div style="margin-left: 2%; margin-top: 1%;margin-right: 2%">
        <div class="layui-upload">
            <button type="button"  class="layui-btn" id="test1">选择图片</button>
        </div>
        <div style="margin-top: 4%"><p id="demoText"></p></div>
        <div>
            <div>
                <div style="float: left; width: 33%; ">原图预览</div>
                <div style="float: left; width: 30%;margin-left: 3%">方形头像</div>
                <div style="float: left; width: 30%;margin-left: 4%">圆形头像</div>
            </div>
            <div style="height: 220px">
                <div style="float: left; width: 33%; height: 300px;">
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" style="width: 202px; height: 202px; border: 1px solid #E7E7EB" id="demo1">
                    </div>
                </div>
                <div style="float: left; width: 30%;margin-left: 3%">
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" style="width: 140px; height: 140px; border: 1px solid #E7E7EB" id="demo2">
                    </div>
                </div>
                <div style="float: left; width: 30%;margin-left: 4%">
                    <div class="layui-upload-list">
                        <img class="round_white_img" style="border: 1px solid #E7E7EB" id="demo3" >
                    </div>
                </div>
            </div>
        </div>
<!--        <div style="text-align:center; margin-top: 30px;">-->
<!--            <button type="button" style="display: block; margin: 0 auto; " class="btn button" onclick="confirmPic()">确认上传</button>-->
<!--        </div>-->
    </div>
</div>


<script type="text/javascript"  th:src="@{/common/common.js}"></script>
<script th:src="@{/layui/layui.js}"></script>
<script>

    const basePath = '[[${#httpServletRequest.getScheme() + "://" + #httpServletRequest.getServerName() + ":" + #httpServletRequest.getServerPort() + #httpServletRequest.getContextPath()}]]';

    let base64Pic = "";

    $(function () {

        initPic();
    });

    function initPic() {
        base64Pic = "";
       const picture = $("#picture").val();
        const account = $("#account").val();
       if(picture === null || picture === undefined || picture === "") {
           let accountPicLabel = "<img id='accountPic' src='photo/headlog.png' style='width: 84px; height: 84px' class='layui-nav-img' alt='点击更换头像' title='点击更换头像' onclick='changePic(\""+account+"\")' />"
           $("#initAccountPic").append(accountPicLabel);
       } else {
           let accountPicLabel = "<img id='accountPic' src='' style='width: 84px; height: 84px' class='layui-nav-img' alt='点击更换头像' title='点击更换头像' onclick='changePic(\""+account+"\")' />"
           $("#initAccountPic").append(accountPicLabel);
           $('#accountPic').attr('src', picture);
       }
    }

    function changePic(account) {

        //弹出一个层
        $("#demoText").val("");
        //$('#demo1').attr('src', ""); //图片链接（base64）
        openAddModel()
    }

    //弹出模态库
    function openAddModel() {

        layer.open({
            type: 1,
            title: '修改头像',
            area: ['730px', '500px'],
            shadeClose: false, //点击遮罩关闭
            content: $('#addModel'),
            offset: '20px',
            btn: ['确定'],
            yes: function(index, layero) {
                confirmPic(index);
            },
            cancel: function () {
                return;
            },
            end: function () {
                $('#addModel').css("display", "none");
                location.reload();
            }
        });
    }

    layui.use('upload', function(){
        var $ = layui.jquery
            ,upload = layui.upload;

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#test1'
            ,url: 'https://httpbin.org/post' //改成您自己的上传接口
            ,before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    base64Pic = "";
                    base64Pic = result;
                    $('#demo1').attr('src', result); //图片链接（base64）
                    $('#demo2').attr('src', result);
                    $('#demo3').attr('src', result);
                });
            }
            ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                    return layer.msg('上传失败');
                }
                //上传成功
            }
            ,error: function(){
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function(){
                    uploadInst.upload();
                });
            }
        });
    });

    function confirmPic(index) {
        //将图像上传到服务器，然后变更当前的头像;

        if(base64Pic === null || base64Pic === undefined || base64Pic === "") {
            layer.msg('请先选择图片'); return;
        }

        const account = $("#account").val();
        const param = {
            "account": account,
            "picture":base64Pic
        };
        $.ajax({
            url     : basePath + "/accountUpdate.json",
            dataType:"json",
            type    :"post",
            async   : false,
            data    : param,
            success:function (result) {
                const code = result.code;
                const msg = result.msg;

                if(code === "0000") {
                    layer.msg("更新成功", { time :2000});
                    setTimeout(function() {
                        //成功之后将模态库去除，然后刷新界面
                        layer.close(index);
                    }, 1000);

                } else {
                    layer.msg(msg, { time :2000});
                }
            },
            error:function (result) {
                $.shotTotal(result, "error");
            }
        })


    }
</script>
</body>
</html>